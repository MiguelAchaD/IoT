{% extends 'base.html' %}
{% load static %}
{% csrf_token %}

{% block title %}
My patients
{% endblock %}

{% block additionalLinks %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<style>
    .selected-day {
        background-color: green !important;
    }
</style>
{% endblock %}

{% block content %}
<div id="calendar"></div>

<!-- Modal for adding reunion -->
<div id="reunionModal" style="display:none;">
    <label for="reunionTitle">Reunion Title:</label>
    <input type="text" id="reunionTitle" name="reunionTitle">
    <label for="reunionStartTime">Start Time:</label>
    <input type="time" id="reunionStartTime" name="reunionStartTime">
    <label for="reunionEndTime">End Time:</label>
    <input type="time" id="reunionEndTime" name="reunionEndTime">
    <label for="reunionDescription">Description:</label>
    <input type="text" id="reunionDescription" name="reunionDescription">
    <label for="reunionUrl">Url (optinal):</label>
    <input type="text" id="reunionUrl" name="reunionUrl">
    <button id="saveReunion">Save Reunion</button>
</div>

<!-- Modal for editing reunion -->
<div id="editReunionModal" style="display:none;">
    <label for="editReunionTitle">Reunion Title:</label>
    <input type="text" id="editReunionTitle" name="editReunionTitle">
    <label for="editReunionStartTime">Start Time:</label>
    <input type="time" id="editReunionStartTime" name="editReunionStartTime">
    <label for="editReunionEndTime">End Time:</label>
    <input type="time" id="editReunionEndTime" name="editReunionEndTime">
    <label for="editReunionDescription">Description:</label>
    <input type="text" id="editReunionDescription" name="editReunionDescription">
    <label for="editReunionUrl">Url:</label>
    <input type="text" id="editReunionUrl" name="editReunionUrl">
    <button id="updateReunion">Update Reunion</button>
    <button id="deleteReunion">Delete Reunion</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var calendarEl = document.getElementById('calendar');
        var selectedDayEl = null;
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: [
                {% for reunion in reunions %}
                {
                    title: "{{ reunion.title }}",
                    start: "{{ reunion.start|date:'Y-m-d\TH:i:s' }}",
                    end: "{{ reunion.end|date:'Y-m-d\TH:i:s' }}",
                    description: "{{ reunion.description }}",
                    url: "{{ reunion.url }}"
                },
                {% endfor %}
            ],
        dateClick: function (info) {
            if (selectedDayEl) {
                selectedDayEl.classList.remove('selected-day');
            }
            selectedDayEl = info.dayEl;
            selectedDayEl.classList.add('selected-day');

            var reunionModal = document.getElementById('reunionModal');
            reunionModal.style.display = 'block';
            document.getElementById('saveReunion').onclick = function () {
                var reunionTitle = document.getElementById('reunionTitle').value;
                var reunionStartTime = document.getElementById('reunionStartTime').value;
                var reunionEndTime = document.getElementById('reunionEndTime').value;
                var reunionDesctiption = document.getElementById('reunionDescription').value;
                var reunionUrl = document.getElementById('reunionUrl').value;
                if (reunionTitle && reunionStartTime && reunionEndTime) {
                    var reunionStartDateTime = info.dateStr + 'T' + reunionStartTime;
                    var reunionEndDateTime = info.dateStr + 'T' + reunionEndTime;

                    var url = `/add-reunion/${encodeURIComponent(reunionTitle)};${encodeURIComponent(reunionStartDateTime)};${encodeURIComponent(reunionEndDateTime)};${encodeURIComponent(reunionDesctiption)};${encodeURIComponent(reunionUrl)}`;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            title: reunionTitle,
                            start: reunionStartDateTime,
                            end: reunionEndDateTime,
                            description: reunionDesctiption,
                            url: reunionUrl
                        })
                    }).then(response => {
                        if (response.ok) {
                            calendar.addEvent({
                                title: reunionTitle,
                                start: reunionStartDateTime,
                                end: reunionEndDateTime,
                                description: reunionDesctiption,
                                url: reunionUrl
                            });
                            reunionModal.style.display = 'none';
                        } else {
                            console.error('Error al guardar el evento.');
                        }
                    }).catch(error => {
                        console.error('Error de conexi√≥n:', error);
                    });
                }

            };
        },
        eventClick: function (info) {
            var editReunionModal = document.getElementById('editReunionModal');
            document.getElementById('editReunionTitle').value = info.reunion.title;
            document.getElementById('editReunionStartTime').value = info.reunion.start.toISOString().substring(11, 16);
            document.getElementById('editReunionEndTime').value = info.reunion.end.toISOString().substring(11, 16);
            editReunionModal.style.display = 'block';

            document.getElementById('updateReunion').onclick = function () {
                var newTitle = document.getElementById('editReunionTitle').value;
                var newStartTime = document.getElementById('editReunionStartTime').value;
                var newEndTime = document.getElementById('editReunionEndTime').value;
                if (newTitle && newStartTime && newEndTime) {
                    var newStartDateTime = info.reunion.start.toISOString().substring(0, 10) + 'T' + newStartTime;
                    var newEndDateTime = info.reunion.start.toISOString().substring(0, 10) + 'T' + newEndTime;
                    info.reunion.setProp('title', newTitle);
                    info.reunion.setStart(newStartDateTime);
                    info.reunion.setEnd(newEndDateTime);
                    editReunionModal.style.display = 'none';
                }
            };

            document.getElementById('deleteReunion').onclick = function () {
                info.reunion.remove();
                editReunionModal.style.display = 'none';
            };
        }
        });
    calendar.render();
    });
</script>
{% endblock %}